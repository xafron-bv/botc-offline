<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Blood on the Clocktower - Offline Grimoire</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#583286">
  <style>
    /* Base styles from the online version */
    :root, :host {
      --fa-font-solid: normal 900 1em/1 "Font Awesome 6 Free";
      --fa-font-regular: normal 400 1em/1 "Font Awesome 6 Free";
    }
    body {
      background-color: #1a1a1a;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    #grimoire {
      flex-grow: 1;
      position: relative;
    }
    #center {
      background-size: cover;
      background-position: center;
      height: 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .circle {
      list-style: none;
      padding: 0;
      margin: 0;
      position: relative;
      width: 80vmin;
      height: 80vmin;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    .circle li {
      position: absolute;
      width: 14vmin;
      height: 14vmin;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .player-token {
        width: 10vmin;
        height: 10vmin;
        background-size: cover;
        background-position: center;
        border-radius: 50%;
        border: 2px solid #fff;
        cursor: pointer;
        position: relative;
    }
    .player-name {
        background: rgba(0,0,0,0.7);
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 5px;
        font-size: 2vmin;
        text-align: center;
        color: white;
    }
    .reminders {
        display: flex;
        position: absolute;
        bottom: -3vmin;
        gap: 1vmin;
    }
    .reminder {
        width: 3vmin;
        height: 3vmin;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
    }
    #sidebar {
      width: 300px;
      background: #2c2c2c;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #sidebar h2 {
        margin-top: 0;
    }
    #character-sheet {
        flex-grow: 1;
    }
    .role {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .role .icon {
        width: 40px;
        height: 40px;
        background-size: contain;
        background-repeat: no-repeat;
        margin-right: 10px;
    }
    .role .name {
        font-weight: bold;
    }
    .team-townsfolk { color: #87ceeb; }
    .team-outsider { color: #add8e6; }
    .team-minion { color: #ff8c00; }
    .team-demon { color: #dc143c; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #2c2c2c;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
    }
    .reminder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 10px;
    }
    .reminder-grid img {
        width: 100%;
        cursor: pointer;
        border-radius: 5px;
        border: 2px solid transparent;
    }
     .reminder-grid img:hover {
        border-color: #fff;
    }
    .button {
        background-color: #583286;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }
    .button:hover {
        background-color: #6a429a;
    }
    #setup-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
        background: #2c2c2c;
        border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="grimoire">
      <div id="center" style="background-image: url('https://botc.app/assets/background4-C7TzDZ7M.webp');">
        <div id="initial-setup" class="modal" style="display: flex;">
            <div class="modal-content">
                <h2>Grimoire Setup</h2>
                <form id="setup-form">
                    <label for="player-count">Number of Players:</label>
                    <input type="number" id="player-count" name="player-count" min="5" max="20" value="12">
                    <label for="script-file">Load Script (JSON):</label>
                    <input type="file" id="script-file" name="script-file" accept=".json">
                    <button type="button" class="button" id="start-game">Start Game</button>
                </form>
            </div>
        </div>
        <ul id="player-circle" class="circle"></ul>
      </div>
    </div>
    <div id="sidebar">
      <h2>Character Sheet</h2>
      <div id="character-sheet">
          <p>Load a script to see characters.</p>
      </div>
    </div>
  </div>

  <div id="reminder-modal" class="modal">
    <div class="modal-content">
      <h3>Add Reminder Token</h3>
      <div id="reminder-grid" class="reminder-grid"></div>
      <button class="button" id="close-modal">Close</button>
    </div>
  </div>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // Application Logic
    document.addEventListener('DOMContentLoaded', () => {
      const startGameBtn = document.getElementById('start-game');
      const scriptFileInput = document.getElementById('script-file');
      const playerCountInput = document.getElementById('player-count');
      const initialSetup = document.getElementById('initial-setup');
      const playerCircle = document.getElementById('player-circle');
      const characterSheet = document.getElementById('character-sheet');
      const reminderModal = document.getElementById('reminder-modal');
      const closeModalBtn = document.getElementById('close-modal');
      const reminderGrid = document.getElementById('reminder-grid');

      let scriptData = null;
      let players = [];
      let selectedPlayerIndex = -1;

      const reminderTokens = [
          'https://botc.app/assets/chef_g-C3a3cGeP.webp',
          'https://botc.app/assets/poisoner_e-Usf7TcoY.webp',
          'https://botc.app/assets/monk_g-D4wNFA-b.webp',
          'https://botc.app/assets/imp_e-DNpveOPY.webp',
          // Add more default token URLs here
      ];

      // Populate reminder modal
      reminderTokens.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.dataset.tokenUrl = url;
          img.onclick = () => addReminderToPlayer(url);
          reminderGrid.appendChild(img);
      });

      scriptFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const json = JSON.parse(e.target.result);
              scriptData = json;
              displayScript(json);
            } catch (error) {
              console.error("Error parsing script file:", error);
              alert("Invalid JSON file.");
            }
          };
          reader.readAsText(file);
        }
      });

      startGameBtn.addEventListener('click', () => {
        const playerCount = parseInt(playerCountInput.value);
        if (playerCount >= 5 && playerCount <= 20) {
          setupGrimoire(playerCount);
          initialSetup.style.display = 'none';
        } else {
          alert('Please enter a player count between 5 and 20.');
        }
      });
      
      function setupGrimoire(count) {
          playerCircle.innerHTML = '';
          players = [];
          const radius = 40; // in vmin
          const angleStep = (2 * Math.PI) / count;

          for (let i = 0; i < count; i++) {
              const angle = i * angleStep - (Math.PI / 2);
              const x = radius * Math.cos(angle);
              const y = radius * Math.sin(angle);
              
              const player = {
                  name: `Player ${i + 1}`,
                  reminders: []
              };
              players.push(player);

              const listItem = document.createElement('li');
              listItem.style.transform = `translate(${x}vmin, ${y}vmin) translate(-50%, -50%)`;
              
              const tokenDiv = document.createElement('div');
              tokenDiv.className = 'player-token';
              tokenDiv.style.backgroundImage = `url('https://botc.app/assets/avatar${i % 25}-u1LxaXkZ.webp')`;
              tokenDiv.onclick = () => {
                  const newName = prompt("Enter player name:", player.name);
                  if (newName) {
                      player.name = newName;
                      updateGrimoire();
                  }
              };

              const nameDiv = document.createElement('div');
              nameDiv.className = 'player-name';
              nameDiv.textContent = player.name;
              
              const remindersDiv = document.createElement('div');
              remindersDiv.className = 'reminders';

              const addReminderBtn = document.createElement('div');
              addReminderBtn.className = 'reminder';
              addReminderBtn.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="white" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>')`;
              addReminderBtn.onclick = (e) => {
                  e.stopPropagation();
                  selectedPlayerIndex = i;
                  reminderModal.style.display = 'flex';
              };
              remindersDiv.appendChild(addReminderBtn);

              listItem.appendChild(tokenDiv);
              listItem.appendChild(nameDiv);
              listItem.appendChild(remindersDiv);
              playerCircle.appendChild(listItem);
          }
          updateGrimoire();
      }
      
      function updateGrimoire() {
          const listItems = playerCircle.querySelectorAll('li');
          listItems.forEach((li, i) => {
              const player = players[i];
              li.querySelector('.player-name').textContent = player.name;
              const remindersDiv = li.querySelector('.reminders');
              
              // Clear old reminders, keep the add button
              while(remindersDiv.children.length > 1) {
                  remindersDiv.removeChild(remindersDiv.firstChild);
              }

              player.reminders.forEach((url, reminderIndex) => {
                  const reminderEl = document.createElement('div');
                  reminderEl.className = 'reminder';
                  reminderEl.style.backgroundImage = `url(${url})`;
                  reminderEl.onclick = (e) => {
                      e.stopPropagation();
                      if (confirm('Remove this reminder?')) {
                          player.reminders.splice(reminderIndex, 1);
                          updateGrimoire();
                      }
                  };
                  remindersDiv.insertBefore(reminderEl, remindersDiv.lastChild);
              });
          });
      }

      function addReminderToPlayer(tokenUrl) {
          if (selectedPlayerIndex > -1) {
              players[selectedPlayerIndex].reminders.push(tokenUrl);
              updateGrimoire();
              reminderModal.style.display = 'none';
              selectedPlayerIndex = -1;
          }
      }
      
      closeModalBtn.onclick = () => {
          reminderModal.style.display = 'none';
      };

      function displayScript(data) {
        characterSheet.innerHTML = '';
        const roles = data.slice(1); // First element is metadata
        const roleDataUrl = 'https://raw.githubusercontent.com/bra1n/townsquare/develop/src/roles.json';
        
        // This part would ideally fetch role details, but for offline, we'll just list names.
        // For a true offline experience, this role data should be cached by the service worker.
        const teams = {townsfolk: [], outsider: [], minion: [], demon: []};
        
        // A simplified mapping for demonstration. A real app would need a full role list.
        const roleTeamMap = {
            "washerwoman": "townsfolk", "librarian": "townsfolk", "investigator": "townsfolk", "chef": "townsfolk",
            "empath": "townsfolk", "fortuneteller": "townsfolk", "undertaker": "townsfolk", "monk": "townsfolk",
            "ravenkeeper": "townsfolk", "virgin": "townsfolk", "slayer": "townsfolk", "soldier": "townsfolk", "mayor": "townsfolk",
            "butler": "outsider", "drunk": "outsider", "recluse": "outsider", "saint": "outsider",
            "poisoner": "minion", "spy": "minion", "scarletwoman": "minion", "baron": "minion",
            "imp": "demon",
            // From custom script
            "knight": "townsfolk", "noble": "townsfolk", "pixie": "townsfolk", "balloonist": "townsfolk", "general": "townsfolk",
            "villageidiot": "townsfolk", "king": "townsfolk", "savant": "townsfolk", "alsaahir": "townsfolk", "huntsman": "townsfolk",
            "fisherman": "townsfolk", "princess": "townsfolk", "cannibal": "townsfolk",
            "mutant": "outsider", "politician": "outsider", "damsel": "outsider",
            "cerenovus": "minion", "marionette": "minion", "goblin": "minion",
            "leviathan": "demon", "bootlegger": "townsfolk", "djinn": "demon"
        };
        
        roles.forEach(roleId => {
            const team = roleTeamMap[roleId] || 'townsfolk';
            if (!teams[team]) teams[team] = [];
            teams[team].push(roleId);
        });

        for (const team in teams) {
            if (teams[team].length > 0) {
                const teamHeader = document.createElement('h3');
                teamHeader.textContent = team.charAt(0).toUpperCase() + team.slice(1);
                teamHeader.className = `team-${team}`;
                characterSheet.appendChild(teamHeader);
                
                teams[team].forEach(roleId => {
                    const roleEl = document.createElement('div');
                    roleEl.className = 'role';
                    
                    const icon = document.createElement('span');
                    icon.className = 'icon';
                    // This uses online assets, which should be cached by the service worker
                    const iconUrl = `https://botc.app/assets/${roleId}_g-CVnYjPdR.webp`; // Placeholder, names differ
                    const evilIconUrl = `https://botc.app/assets/${roleId}_e-Usf7TcoY.webp`;
                    
                    const img = new Image();
                    img.src = iconUrl;
                    img.onload = () => { icon.style.backgroundImage = `url(${iconUrl})`; };
                    img.onerror = () => { 
                        const evilImg = new Image();
                        evilImg.src = evilIconUrl;
                        evilImg.onload = () => { icon.style.backgroundImage = `url(${evilIconUrl})`; };
                        evilImg.onerror = () => { /* fallback icon */ };
                    };


                    const name = document.createElement('span');
                    name.className = 'name';
                    name.textContent = roleId.charAt(0).toUpperCase() + roleId.slice(1);
                    
                    roleEl.appendChild(icon);
                    roleEl.appendChild(name);
                    characterSheet.appendChild(roleEl);
                });
            }
        }
      }
    });
  </script>
</body>
</html>
