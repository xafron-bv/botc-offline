<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Blood on the Clocktower - Offline Grimoire</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#583286">
  <style>
    :root {
      --token-size: 12vmin;
      --reminder-size: 3.5vmin;
    }
    body {
      background-color: #1a1a1a;
      color: #fff;
      font-family: 'Verdana', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    #grimoire {
      flex-grow: 1;
      position: relative;
    }
    #center {
      background-image: url('https://botc.app/assets/background4-C7TzDZ7M.webp');
      background-size: cover;
      background-position: center;
      height: 100%;
      width: 100%;
      position: relative;
    }
    .circle {
      list-style: none;
      padding: 0;
      margin: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80vmin;
      height: 80vmin;
      transform: translate(-50%, -50%);
    }
    .circle li {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: var(--token-size);
      height: var(--token-size);
      /* Positioning is now handled by JS */
    }
    .player-token {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        border-radius: 50%;
        border: 3px solid rgba(160, 140, 91, 0.7);
        box-shadow: 0 0 10px rgba(0,0,0,0.7);
        cursor: pointer;
        position: relative;
        background-color: rgba(0,0,0,0.3);
    }
    .player-name {
        background: rgba(0,0,0,0.8);
        padding: 0.5vmin 1.5vmin;
        border-radius: 15px;
        margin-top: 1vmin;
        font-size: 2vmin;
        text-align: center;
        color: white;
        cursor: pointer;
        white-space: nowrap;
    }
    .reminders {
        display: flex;
        position: absolute;
        bottom: -4.5vmin;
        gap: 0.5vmin;
        justify-content: center;
        width: 100%;
        pointer-events: none;
    }
     .text-reminder {
        background: rgba(0,0,0,0.8);
        border: 1px solid #a08c5b;
        color: white;
        padding: 0.5vmin;
        border-radius: 5px;
        font-size: 1.5vmin;
        cursor: pointer;
        pointer-events: auto;
        max-width: 8vmin;
        text-align: center;
        word-wrap: break-word;
    }
    .reminder-placeholder {
        position: absolute;
        bottom: -4.5vmin;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(160, 140, 91, 0.7);
        color: white;
        width: 2vmin;
        height: 2vmin;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.5vmin;
        font-weight: bold;
    }
    #sidebar {
      width: 300px;
      background-color: #2a2a2a;
      padding: 20px;
      overflow-y: auto;
      border-right: 2px solid #583286;
    }
    .button {
      background-color: #583286;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .button:hover {
      background-color: #7a4ba8;
    }
    .button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    input[type="number"] {
      background-color: #3a3a3a;
      color: white;
      border: 1px solid #583286;
      padding: 8px;
      border-radius: 3px;
      margin: 5px;
      width: 80px;
    }
    input[type="file"] {
      background-color: #3a3a3a;
      color: white;
      border: 1px solid #583286;
      padding: 8px;
      border-radius: 3px;
      margin: 5px;
    }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #333;
      border-radius: 5px;
    }
    .section h3 {
      margin-top: 0;
      color: #a08c5b;
    }
    #character-sheet {
      max-height: 400px;
      overflow-y: auto;
    }
    .role {
      display: flex;
      align-items: center;
      margin: 5px 0;
      padding: 5px;
      background-color: #444;
      border-radius: 3px;
    }
    .role .icon {
      width: 30px;
      height: 30px;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      margin-right: 10px;
    }
    .role .name {
      color: #fff;
    }
    .team-townsfolk { color: #4CAF50; }
    .team-outsider { color: #FF9800; }
    .team-minion { color: #F44336; }
    .team-demon { color: #9C27B0; }
    .team-travellers { color: #2196F3; }
    .team-fabled { color: #FFC107; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
    }
    #character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 10px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .token {
      width: 60px;
      height: 60px;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .token:hover {
      border-color: #a08c5b;
    }
    #character-search {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      background-color: #3a3a3a;
      color: white;
      border: 1px solid #583286;
      border-radius: 3px;
    }
    .status {
      color: #4CAF50;
      font-size: 12px;
      margin: 5px 0;
    }
    .error {
      color: #F44336;
      font-size: 12px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <div class="section">
        <h3>Game Setup</h3>
        <div>
          <label for="player-count">Player Count:</label>
          <input type="number" id="player-count" min="5" max="20" value="7">
        </div>
        <button class="button" id="start-game">Start Game</button>
      </div>

      <div class="section">
        <h3>Script Management</h3>
        <div>
          <button class="button" id="load-default-tokens">Load Default Tokens</button>
          <div class="status" id="load-status"></div>
        </div>
        <div style="margin-top: 10px;">
          <label for="script-file">Or Upload Custom Script:</label>
          <input type="file" id="script-file" accept=".json">
        </div>
      </div>

      <div class="section">
        <h3>Character Sheet</h3>
        <div id="character-sheet">
          <p>Load a script to see available characters.</p>
        </div>
      </div>
    </div>

    <div id="grimoire">
      <div id="center">
        <ul id="player-circle" class="circle"></ul>
      </div>
    </div>
  </div>

  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h3>Select Character for <span id="character-modal-player-name"></span></h3>
      <input type="text" id="character-search" placeholder="Search characters...">
      <div id="character-grid"></div>
      <button class="button" id="close-character-modal">Cancel</button>
    </div>
  </div>

  <div id="text-reminder-modal" class="modal">
    <div class="modal-content">
      <h3>Add/Edit Reminder</h3>
      <input type="text" id="reminder-text-input" placeholder="Enter reminder text...">
      <button class="button" id="save-reminder-btn">Save</button>
      <button class="button" id="cancel-reminder-btn">Cancel</button>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js'));
    }

    document.addEventListener('DOMContentLoaded', () => {
      const startGameBtn = document.getElementById('start-game');
      const loadDefaultTokensBtn = document.getElementById('load-default-tokens');
      const scriptFileInput = document.getElementById('script-file');
      const playerCountInput = document.getElementById('player-count');
      const playerCircle = document.getElementById('player-circle');
      const characterSheet = document.getElementById('character-sheet');
      const loadStatus = document.getElementById('load-status');
      
      const characterModal = document.getElementById('character-modal');
      const closeCharacterModalBtn = document.getElementById('close-character-modal');
      const characterGrid = document.getElementById('character-grid');
      const characterSearch = document.getElementById('character-search');
      const characterModalPlayerName = document.getElementById('character-modal-player-name');

      const textReminderModal = document.getElementById('text-reminder-modal');
      const reminderTextInput = document.getElementById('reminder-text-input');
      const saveReminderBtn = document.getElementById('save-reminder-btn');
      const cancelReminderBtn = document.getElementById('cancel-reminder-btn');

      let scriptData = null;
      let allRoles = {};
      let players = [];
      let selectedPlayerIndex = -1;
      let editingReminder = { playerIndex: -1, reminderIndex: -1 };

      // Load default tokens from local JSON file
      loadDefaultTokensBtn.addEventListener('click', async () => {
        try {
          loadStatus.textContent = 'Loading default tokens...';
          loadStatus.className = 'status';
          
          const response = await fetch('./tokens.json');
          if (!response.ok) {
            throw new Error('Failed to load tokens.json');
          }
          
          const tokens = await response.json();
          processScriptData(tokens);
          
          loadStatus.textContent = 'Default tokens loaded successfully!';
          loadStatus.className = 'status';
          
          // Preload token images for offline use
          preloadTokenImages(tokens);
        } catch (error) {
          console.error('Error loading default tokens:', error);
          loadStatus.textContent = 'Error loading default tokens: ' + error.message;
          loadStatus.className = 'error';
        }
      });

      // Preload token images to cache them for offline use
      function preloadTokenImages(tokens) {
        const imageUrls = [];
        Object.values(tokens).forEach(team => {
          if (Array.isArray(team)) {
            team.forEach(role => {
              if (role.image) {
                imageUrls.push(role.image);
              }
            });
          }
        });

        // Cache images in service worker
        if ('caches' in window) {
          caches.open('botc-offline-grimoire-v1').then(cache => {
            imageUrls.forEach(url => {
              fetch(url).then(response => {
                if (response.ok) {
                  cache.put(url, response.clone());
                }
              }).catch(() => {
                // Ignore failed image loads
              });
            });
          });
        }
      }

      scriptFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const json = JSON.parse(e.target.result);
            processScriptData(json);
            loadStatus.textContent = 'Custom script loaded successfully!';
            loadStatus.className = 'status';
          } catch (error) { 
            loadStatus.textContent = 'Invalid JSON file.';
            loadStatus.className = 'error';
          }
        };
        reader.readAsText(file);
      });

      function processScriptData(data) {
          scriptData = data;
          allRoles = {};
          for (const team in data) {
              if (Array.isArray(data[team])) {
                  data[team].forEach(role => {
                      allRoles[role.id] = { ...role, team };
                  });
              }
          }
          displayScript(data);
      }

      startGameBtn.addEventListener('click', () => {
        const playerCount = parseInt(playerCountInput.value);
        if (playerCount >= 5 && playerCount <= 20) {
          setupGrimoire(playerCount);
        } else {
          alert('Player count must be between 5 and 20.');
        }
      });

      function setupGrimoire(count) {
          playerCircle.innerHTML = '';
          players = Array.from({ length: count }, (_, i) => ({
              name: `Player ${i + 1}`,
              character: null,
              reminders: []
          }));
          
          players.forEach((player, i) => {
              const listItem = document.createElement('li');
              listItem.innerHTML = `
                  <div class="reminders"></div>
                  <div class="player-token" title="Assign character"></div>
                  <div class="player-name" title="Edit name">${player.name}</div>
                  <div class="reminder-placeholder" title="Add text reminder">+</div>
              `;
              playerCircle.appendChild(listItem);

              listItem.querySelector('.player-token').onclick = () => openCharacterModal(i);
              listItem.querySelector('.player-name').onclick = (e) => {
                  e.stopPropagation();
                  const newName = prompt("Enter player name:", player.name);
                  if (newName) {
                      players[i].name = newName;
                      updateGrimoire();
                  }
              };
              listItem.querySelector('.reminder-placeholder').onclick = (e) => {
                  e.stopPropagation();
                  openTextReminderModal(i);
              };
          });
          
          setTimeout(repositionPlayers, 0);
          updateGrimoire();
      }

      function repositionPlayers() {
          const count = players.length;
          if (count === 0) return;
          const circle = document.getElementById('player-circle');
          const radius = circle.offsetWidth / 2.5; 
          const angleStep = (2 * Math.PI) / count;

          const listItems = circle.querySelectorAll('li');
          listItems.forEach((listItem, i) => {
              const angle = i * angleStep - (Math.PI / 2);
              const x = (circle.offsetWidth / 2) + radius * Math.cos(angle) - (listItem.offsetWidth / 2);
              const y = (circle.offsetHeight / 2) + radius * Math.sin(angle) - (listItem.offsetHeight / 2);
              listItem.style.position = 'absolute';
              listItem.style.left = `${x}px`;
              listItem.style.top = `${y}px`;
          });
      }

      function updateGrimoire() {
          const listItems = playerCircle.querySelectorAll('li');
          listItems.forEach((li, i) => {
              const player = players[i];
              li.querySelector('.player-name').textContent = player.name;
              const tokenDiv = li.querySelector('.player-token');
              const characterImage = player.character && allRoles[player.character] 
                ? allRoles[player.character].image 
                : 'https://botc.app/assets/token-blank-05128509.webp';
              tokenDiv.style.backgroundImage = `url('${characterImage}')`;
              
              if(player.character) {
                tokenDiv.style.borderColor = '#a08c5b';
                tokenDiv.style.backgroundColor = 'transparent';
              } else {
                tokenDiv.style.borderColor = 'rgba(255,255,255,0.5)';
                tokenDiv.style.backgroundColor = 'rgba(0,0,0,0.3)';
              }

              const remindersDiv = li.querySelector('.reminders');
              remindersDiv.innerHTML = '';
              player.reminders.forEach((reminder, reminderIndex) => {
                  const reminderEl = document.createElement('div');
                  reminderEl.className = 'text-reminder';
                  reminderEl.textContent = reminder.value;
                  reminderEl.onclick = (e) => {
                      e.stopPropagation();
                      openTextReminderModal(i, reminderIndex, reminder.value);
                  };
                  remindersDiv.appendChild(reminderEl);
              });
          });
      }
      
      function openCharacterModal(playerIndex) {
          if (!scriptData) {
              alert("Please load a script first.");
              return;
          }
          selectedPlayerIndex = playerIndex;
          characterModalPlayerName.textContent = players[playerIndex].name;
          populateCharacterGrid();
          characterModal.style.display = 'flex';
          characterSearch.value = '';
          characterSearch.focus();
      }

      function populateCharacterGrid() {
          characterGrid.innerHTML = '';
          const filter = characterSearch.value.toLowerCase();
          
          Object.values(allRoles)
              .filter(role => role.name.toLowerCase().includes(filter))
              .forEach(role => {
                  const tokenEl = document.createElement('div');
                  tokenEl.className = 'token';
                  tokenEl.style.backgroundImage = `url('${role.image}')`;
                  tokenEl.title = role.name;
                  tokenEl.onclick = () => assignCharacter(role.id);
                  characterGrid.appendChild(tokenEl);
              });
      }

      function assignCharacter(roleId) {
          if (selectedPlayerIndex > -1) {
              players[selectedPlayerIndex].character = roleId;
              updateGrimoire();
              characterModal.style.display = 'none';
          }
      }

      function openTextReminderModal(playerIndex, reminderIndex = -1, existingText = '') {
          editingReminder = { playerIndex, reminderIndex };
          reminderTextInput.value = existingText;
          textReminderModal.style.display = 'flex';
          reminderTextInput.focus();
      }

      saveReminderBtn.onclick = () => {
          const text = reminderTextInput.value.trim();
          const { playerIndex, reminderIndex } = editingReminder;
          if (text) {
              if (reminderIndex > -1) {
                  players[playerIndex].reminders[reminderIndex].value = text;
              } else {
                  players[playerIndex].reminders.push({ type: 'text', value: text });
              }
          } else if (reminderIndex > -1) {
              players[playerIndex].reminders.splice(reminderIndex, 1);
          }
          updateGrimoire();
          textReminderModal.style.display = 'none';
      };

      closeCharacterModalBtn.onclick = () => characterModal.style.display = 'none';
      cancelReminderBtn.onclick = () => textReminderModal.style.display = 'none';
      characterSearch.oninput = populateCharacterGrid;
      window.addEventListener('resize', repositionPlayers);
      
      function displayScript(data) {
        characterSheet.innerHTML = '';
        const teamOrder = ['townsfolk', 'outsider', 'minion', 'demon', 'travellers', 'fabled'];
        
        teamOrder.forEach(team => {
            if (data[team] && Array.isArray(data[team]) && data[team].length > 0) {
                const teamHeader = document.createElement('h3');
                teamHeader.textContent = team.charAt(0).toUpperCase() + team.slice(1);
                teamHeader.className = `team-${team}`;
                characterSheet.appendChild(teamHeader);
                
                data[team].forEach(role => {
                    const roleEl = document.createElement('div');
                    roleEl.className = 'role';
                    roleEl.innerHTML = `
                        <span class="icon" style="background-image: url('${role.image}')"></span>
                        <span class="name">${role.name}</span>
                    `;
                    characterSheet.appendChild(roleEl);
                });
            }
        });
      }

      // Auto-load default tokens on page load
      window.addEventListener('load', () => {
        setTimeout(() => {
          loadDefaultTokensBtn.click();
        }, 1000);
      });
    });
  </script>
</body>
</html>
